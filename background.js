"use strict";(()=>{const o={TOKEN:"clickupToken",REFRESH_TOKEN:"clickupRefreshToken",OAUTH_CONFIG:"oauthConfig",DEFAULT_LIST:"defaultList",EMAIL_TASKS:"emailTaskMappings",TEAMS:"cachedTeams",USER:"cachedUser",HIERARCHY_CACHE:"hierarchyCache",EMAIL_TASKS_SYNC:"emailTasksSync"},E="https://api.clickup.com/api/v2";let c=null,g=null,S=null;chrome.runtime.onInstalled.addListener(()=>{console.log("[ClickUp] Extension installed")});chrome.runtime.onMessage.addListener((a,e,s)=>(I(a,e).then(s),!0));async function I(a,e){const{action:s,data:t}=a;switch(s){case"getStatus":return await R();case"authenticate":return await _();case"logout":return await O();case"saveOAuthConfig":return await A(t);case"getTeams":case"getHierarchy":return await P();case"getSpaces":return await N(a.teamId||t?.teamId);case"getFolders":return await L(a.spaceId||t?.spaceId);case"getLists":return await M({spaceId:a.spaceId||t?.spaceId,folderId:a.folderId||t?.folderId});case"getMembers":return await $(t.listId);case"createTask":return await j(a.emailData||t);case"createTaskFull":return await V(a);case"setDefaultList":return await chrome.storage.local.set({[o.DEFAULT_LIST]:t.listId}),{success:!0};case"getTaskById":return await K(a.taskId||t?.taskId);case"searchTasks":return await H(a.query||t?.query);case"attachToTask":return await Y(a);case"validateTask":return await B(a.taskId||t?.taskId);case"findLinkedTasks":return await J(a.threadIds||t);case"testTokenRefresh":return await F();case"preloadFullHierarchy":return await U();case"getHierarchyCache":return await D();case"syncEmailTasks":return await v(a.days||t?.days||30);case"getEmailTasksSyncStatus":return await G();default:return console.log("[ClickUp] Unknown action:",s),{error:"Unknown action"}}}async function R(){const a=await chrome.storage.local.get([o.TOKEN,o.OAUTH_CONFIG,o.USER]);return{authenticated:!!a[o.TOKEN],configured:!!a[o.OAUTH_CONFIG]?.clientId,user:a[o.USER]||null}}async function A(a){return await chrome.storage.local.set({[o.OAUTH_CONFIG]:a}),{success:!0}}async function _(){const e=(await chrome.storage.local.get(o.OAUTH_CONFIG))[o.OAUTH_CONFIG];if(!e?.clientId||!e?.clientSecret)throw new Error("OAuth not configured");const s=chrome.identity.getRedirectURL(),t=`https://app.clickup.com/api?client_id=${e.clientId}&redirect_uri=${encodeURIComponent(s)}`;try{const n=await chrome.identity.launchWebAuthFlow({url:t,interactive:!0});if(!n)throw new Error("No response URL from OAuth flow");const i=new URL(n).searchParams.get("code");if(!i)throw new Error("No authorization code received");const r=await(await fetch("https://api.clickup.com/api/v2/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:e.clientId,client_secret:e.clientSecret,code:i})})).json();if(console.log("[ClickUp] OAuth token response:",JSON.stringify(r,null,2)),r.access_token){await chrome.storage.local.set({[o.TOKEN]:r.access_token,[o.REFRESH_TOKEN]:r.refresh_token||null}),c=new h(r.access_token);const d=await c.getUser();return await chrome.storage.local.set({[o.USER]:d}),U().catch(p=>console.error("[ClickUp] Background preload failed:",p)),{success:!0,user:d}}throw new Error(r.error||"Failed to get token")}catch(n){throw console.error("[ClickUp] OAuth error:",n),n}}async function O(){return await chrome.storage.local.remove([o.TOKEN,o.REFRESH_TOKEN,o.USER,o.TEAMS]),c=null,g=null,S=null,{success:!0}}async function b(){console.log("[ClickUp] Attempting token refresh...");const a=await chrome.storage.local.get([o.OAUTH_CONFIG,o.REFRESH_TOKEN]),e=a[o.OAUTH_CONFIG],s=a[o.REFRESH_TOKEN];if(!s||!e?.clientId)return console.log("[ClickUp] No refresh token available"),!1;try{const n=await(await fetch("https://api.clickup.com/api/v2/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:e.clientId,client_secret:e.clientSecret,refresh_token:s,grant_type:"refresh_token"})})).json();return n.access_token?(await chrome.storage.local.set({[o.TOKEN]:n.access_token,[o.REFRESH_TOKEN]:n.refresh_token||s}),c=new h(n.access_token),console.log("[ClickUp] Token refreshed successfully"),!0):(console.error("[ClickUp] Token refresh failed:",n.error),!1)}catch(t){return console.error("[ClickUp] Token refresh error:",t),!1}}async function F(){console.log("[ClickUp] Starting token/auth test...");try{const e=(await chrome.storage.local.get([o.TOKEN,o.REFRESH_TOKEN]))[o.TOKEN];if(!e)return{success:!1,error:"No token found. Please authenticate first."};console.log("[ClickUp] Note: ClickUp tokens do not expire"),console.log("[ClickUp] Verifying current token...");try{const s=await c.getUser();console.log("[ClickUp] Current token valid. User:",s.user?.username)}catch(s){return{success:!1,error:"Current token is invalid: "+s.message}}console.log("[ClickUp] Testing with corrupted token..."),await chrome.storage.local.set({[o.TOKEN]:"CORRUPTED_TOKEN_TEST"}),c=new h("CORRUPTED_TOKEN_TEST");try{return await c.getUser(),{success:!1,error:"Corrupted token was accepted (unexpected)"}}catch(s){console.log("[ClickUp] Got expected error:",s.message),await chrome.storage.local.set({[o.TOKEN]:e}),c=new h(e);try{return{success:!0,message:`401 handling works! Token restored. User: ${(await c.getUser()).user?.username||"verified"}`}}catch(t){return{success:!1,error:"Failed to restore token: "+t.message}}}}catch(a){return console.error("[ClickUp] Token test error:",a),{success:!1,error:a.message}}}async function P(){return await m(),g||(g=await c.getTeams(),await chrome.storage.local.set({[o.TEAMS]:g})),g}async function N(a){return await m(),await c.getSpaces(a)}async function L(a){return await m(),await c.getFolders(a)}async function M(a){return await m(),a.folderId?await c.getListsInFolder(a.folderId):await c.getListsInSpace(a.spaceId)}async function $(a){return await m(),await c.getListMembers(a)}async function K(a){try{return await m(),await c.getTask(a)}catch(e){return console.log("[ClickUp] Task lookup failed:",a,e.message),null}}async function H(a){await m(),g||(g=await c.getTeams());const e=g.teams[0]?.id;return e?await c.searchTasks(e,a):{tasks:[]}}async function U(){console.log("[ClickUp] Starting hierarchy preload...");try{await m();const a=await c.getTeams();if(!a.teams||a.teams.length===0)return{success:!1,listCount:0};const e=a.teams[0],s=e.id,t=e.members||[],l=(await c.getSpaces(s)).spaces||[];console.log("[ClickUp] Preloading lists for",l.length,"spaces...");const i=[];for(const r of l){const d=r.color||"#7B68EE",p=r.avatar?.url||null;try{const f=await c.getListsInSpace(r.id);if(f.lists)for(const k of f.lists)i.push({id:k.id,name:k.name,path:`${r.name} > ${k.name}`,spaceName:r.name,spaceColor:d,spaceAvatar:p});const T=await c.getFolders(r.id);if(T.folders)for(const k of T.folders){const C=await c.getListsInFolder(k.id);if(C.lists)for(const w of C.lists)i.push({id:w.id,name:w.name,path:`${r.name} > ${k.name} > ${w.name}`,spaceName:r.name,folderName:k.name,spaceColor:d,spaceAvatar:p})}}catch(f){console.error("[ClickUp] Error loading space lists:",r.name,f)}}const u={lists:i,spaces:l.map(r=>({id:r.id,name:r.name,color:r.color,avatar:r.avatar})),members:t,teamId:s,timestamp:Date.now()};return await chrome.storage.local.set({[o.HIERARCHY_CACHE]:u}),console.log("[ClickUp] Hierarchy preload complete:",i.length,"lists cached"),{success:!0,listCount:i.length}}catch(a){return console.error("[ClickUp] Hierarchy preload failed:",a),{success:!1,listCount:0}}}async function D(){return(await chrome.storage.local.get(o.HIERARCHY_CACHE))[o.HIERARCHY_CACHE]||null}async function v(a){console.log("[ClickUp] Starting email tasks sync for last",a,"days...");try{await m(),g||(g=await c.getTeams());const e=g.teams[0]?.id;if(!e)return{success:!1,foundCount:0};const s=Date.now()-a*24*60*60*1e3;console.log("[ClickUp] Searching tasks updated since:",new Date(s).toISOString());const t=await c.getRecentTasks(e,s);console.log("[ClickUp] Fetched",t.length,"recent tasks");const l=(await chrome.storage.local.get(o.EMAIL_TASKS))[o.EMAIL_TASKS]||{};let i=0;for(const r of t){let d=x(r);if(!d)try{const p=await c.getTaskComments(r.id);for(const f of p){const T=q(f.comment_text||"");if(T){d=T;break}}}catch{console.log("[ClickUp] Error fetching comments for task:",r.id)}d&&(l[d]||(l[d]=[]),l[d].find(f=>f.id===r.id)||(l[d].push({id:r.id,name:r.name,url:r.url,status:r.status?.status||"unknown",createdAt:Date.now()}),i++,console.log("[ClickUp] Found linked task:",r.id,"-> thread:",d)))}await chrome.storage.local.set({[o.EMAIL_TASKS]:l});const u={lastSync:Date.now(),foundCount:i,days:a};return await chrome.storage.local.set({[o.EMAIL_TASKS_SYNC]:u}),console.log("[ClickUp] Email tasks sync complete. Found",i,"new links"),{success:!0,foundCount:i}}catch(e){return console.error("[ClickUp] Email tasks sync failed:",e),{success:!1,foundCount:0}}}function x(a){const e=[/_Thread ID: ([a-f0-9]+)_/i,/Thread ID: ([a-f0-9]+)/i,/threadId=([a-f0-9]+)/i,/inbox\/([a-f0-9]+)/i];for(const s of e){const t=a.name?.match(s);if(t)return t[1]}for(const s of e){const t=a.description?.match(s);if(t)return t[1]}for(const s of e){const t=a.text_content?.match(s);if(t)return t[1]}return null}function q(a){if(!a)return null;const e=[/_Thread ID: ([a-f0-9]+)_/i,/Thread ID: ([a-f0-9]+)/i,/threadId=([a-f0-9]+)/i,/inbox\/([a-f0-9]+)/i];for(const s of e){const t=a.match(s);if(t)return t[1]}return null}async function G(){return(await chrome.storage.local.get(o.EMAIL_TASKS_SYNC))[o.EMAIL_TASKS_SYNC]||null}async function j(a){await m();const s=(await chrome.storage.local.get(o.DEFAULT_LIST))[o.DEFAULT_LIST];if(!s)throw new Error("No default list configured");const t=`https://mail.google.com/mail/u/0/#inbox/${a.threadId}`,n={name:a.subject||"Email Task",description:`\u{1F4E7} **Email from:** ${a.from}

\u{1F517} [Ver email original en Gmail](${t})

_Thread ID: ${a.threadId}_`},l=await c.createTask(s,n);await y(a.threadId,l);try{const i=`\u{1F4E7} **Email vinculado:**
\u{1F517} [Ver email original en Gmail](${t})

_Thread ID: ${a.threadId}_`;await c.addComment(l.id,i)}catch(i){console.error("[ClickUp] Failed to add comment:",i)}if(a.html)try{await c.uploadAttachment(l.id,a.html,a.subject,a)}catch(i){console.error("[ClickUp] Failed to upload attachment:",i)}if(chrome.tabs){const i=await chrome.tabs.query({active:!0,currentWindow:!0});i[0]?.id&&chrome.tabs.sendMessage(i[0].id,{action:"taskCreated",data:{threadId:a.threadId,task:l}})}return l}async function Y(a){await m();const{taskId:e,emailData:s}=a,n=`\u{1F4E7} **Email adjuntado:**
\u{1F517} [Ver en Gmail](${`https://mail.google.com/mail/u/0/#inbox/${s.threadId}`})

**From:** ${s.from}
**Subject:** ${s.subject}`;await c.addComment(e,n),s.html&&await c.uploadAttachment(e,s.html,s.subject,s);const l=await c.getTask(e);return await y(s.threadId,l),l}async function V(a){await m();const{listId:e,taskData:s,emailData:t,timeTracked:n,teamId:l}=a;if(!e)throw new Error("No list selected");if(t?.threadId){const r=`

---
\u{1F517} [Ver email original en Gmail](${`https://mail.google.com/mail/u/0/#inbox/${t.threadId}`})
_Thread ID: ${t.threadId}_`;s.description=(s.description||"")+r}const i=await c.createTask(e,s);if(t?.threadId){const u=`https://mail.google.com/mail/u/0/#inbox/${t.threadId}`;try{const r=`\u{1F4E7} **Email vinculado:**
\u{1F517} [Ver email original en Gmail](${u})

_Thread ID: ${t.threadId}_`;await c.addComment(i.id,r)}catch(r){console.error("[ClickUp] Failed to add comment:",r)}if(t.html)try{await c.uploadAttachment(i.id,t.html,t.subject||"Email",t)}catch(r){console.error("[ClickUp] Failed to upload attachment:",r)}if(a.attachWithFiles&&t.attachments&&t.attachments.length>0){console.log("[ClickUp] Uploading",t.attachments.length,"email attachments...");for(const r of t.attachments)try{await c.uploadFileFromUrl(i.id,r.url,r.filename,r.mimeType),console.log("[ClickUp] Uploaded attachment:",r.filename)}catch(d){console.error("[ClickUp] Failed to upload file attachment:",r.filename,d)}}await y(t.threadId,i)}if(n&&l)try{await c.trackTime(i.id,l,n)}catch(u){console.error("[ClickUp] Failed to track time:",u)}if(chrome.tabs&&t?.threadId){const u=await chrome.tabs.query({active:!0,currentWindow:!0});u[0]?.id&&chrome.tabs.sendMessage(u[0].id,{action:"taskCreated",data:{threadId:t.threadId,task:i}})}return i}async function y(a,e){const t=(await chrome.storage.local.get(o.EMAIL_TASKS))[o.EMAIL_TASKS]||{};t[a]||(t[a]=[]),t[a].find(n=>n.id===e.id)||t[a].push({id:e.id,name:e.name,url:e.url}),await chrome.storage.local.set({[o.EMAIL_TASKS]:t})}async function B(a){try{await m();const e=await c.getTask(a);return e.archived?{exists:!1,reason:"archived"}:{exists:!!(e&&e.id),reason:"exists"}}catch(e){const s=e.status||0,t=(e.message||"").toLowerCase();return s===404||s===403?{exists:!1,reason:"api_error",errorStatus:s}:t.includes("not found")||t.includes("deleted")||t.includes("does not exist")?{exists:!1,reason:"deleted",error:e.message}:{exists:!0,error:e.message}}}async function J(a){const s=(await chrome.storage.local.get(o.EMAIL_TASKS))[o.EMAIL_TASKS]||{},t={};for(const n of a)s[n]&&(t[n]=s[n]);return t}async function m(){if(!c){const a=await chrome.storage.local.get(o.TOKEN);if(a[o.TOKEN])c=new h(a[o.TOKEN]);else throw new Error("Not authenticated")}}class h{constructor(e){this.token=e}static{this.MAX_RETRIES=3}static{this.RETRY_STATUS_CODES=[429,500,502,503,504]}async request(e,s={},t=0){try{const n=await fetch(`${E}${e}`,{...s,headers:{Authorization:this.token,"Content-Type":"application/json",...s.headers}});if(n.status===401&&t===0){if(console.log("[ClickUp] Got 401 Unauthorized, attempting token refresh..."),await b()){const u=await chrome.storage.local.get(o.TOKEN);return this.token=u[o.TOKEN],this.request(e,s,1)}const i=new Error("Authentication failed. Please sign out and sign in again.");throw i.status=401,i.requiresReauth=!0,i}if(h.RETRY_STATUS_CODES.includes(n.status)&&t<h.MAX_RETRIES){const l=Math.pow(2,t)*1e3;return console.log(`[ClickUp] Got ${n.status}, retrying in ${l}ms (attempt ${t+1}/${h.MAX_RETRIES})`),await this.sleep(l),this.request(e,s,t+1)}if(!n.ok){const l=await n.json().catch(()=>({})),i=new Error(l.err||`API Error: ${n.status}`);throw i.status=n.status,i}return n.json()}catch(n){if(n.name==="TypeError"&&n.message.includes("fetch")&&t<h.MAX_RETRIES){const l=Math.pow(2,t)*1e3;return console.log(`[ClickUp] Network error, retrying in ${l}ms (attempt ${t+1}/${h.MAX_RETRIES})`),await this.sleep(l),this.request(e,s,t+1)}throw n}}sleep(e){return new Promise(s=>setTimeout(s,e))}async getUser(){return this.request("/user")}async getTeams(){return this.request("/team")}async getSpaces(e){return this.request(`/team/${e}/space`)}async getFolders(e){return this.request(`/space/${e}/folder`)}async getListsInSpace(e){return this.request(`/space/${e}/list`)}async getListsInFolder(e){return this.request(`/folder/${e}/list`)}async getListMembers(e){return this.request(`/list/${e}/member`)}async createTask(e,s){return this.request(`/list/${e}/task`,{method:"POST",body:JSON.stringify(s)})}async getTask(e){return this.request(`/task/${e}`)}async addComment(e,s){return this.request(`/task/${e}/comment`,{method:"POST",body:JSON.stringify({comment_text:s})})}async searchTasks(e,s){return this.request(`/team/${e}/task?query=${encodeURIComponent(s)}`)}async getRecentTasks(e,s){const t=await this.request(`/team/${e}/task?include_closed=true&date_updated_gt=${s}&page=0`);return console.log("[ClickUp] getRecentTasks API response:",JSON.stringify(t).substring(0,500)),t.tasks||[]}async getTaskComments(e){return(await this.request(`/task/${e}/comment`)).comments||[]}async uploadAttachment(e,s,t,n=null){const l=new FormData,i=(t||"Email").replace(/[<>:"/\\|?*]/g,"").substring(0,100)+".html",u=new Blob([s],{type:"text/html"});if(l.append("attachment",u,i),n?.threadId){const d=JSON.stringify({id:n.threadId,subject:n.subject||t,from:n.from||"",email:n.email||n.userEmail||"",msg:n.threadId,client:"gmail"});l.append("email",d)}const r=await fetch(`${E}/task/${e}/attachment`,{method:"POST",headers:{Authorization:this.token},body:l});if(!r.ok)throw new Error(`Upload failed: ${r.status}`);return r.json()}async uploadFileFromUrl(e,s,t,n){console.log("[ClickUp] Downloading file:",t,"from:",s.substring(0,100));const l=await fetch(s,{credentials:"include"});if(!l.ok)throw new Error(`Failed to download file: ${l.status}`);const i=await l.blob(),u=new FormData;u.append("attachment",i,t);const r=await fetch(`${E}/task/${e}/attachment`,{method:"POST",headers:{Authorization:this.token},body:u});if(!r.ok)throw new Error(`Upload failed: ${r.status}`);return r.json()}async trackTime(e,s,t){const n=Date.now();return this.request(`/team/${s}/time_entries`,{method:"POST",body:JSON.stringify({tid:e,start:n-t,duration:t})})}}})();
