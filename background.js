"use strict";(()=>{const n={TOKEN:"clickupToken",REFRESH_TOKEN:"clickupRefreshToken",OAUTH_CONFIG:"oauthConfig",DEFAULT_LIST:"defaultList",EMAIL_TASKS:"emailTaskMappings",TEAMS:"cachedTeams",USER:"cachedUser"},p="https://api.clickup.com/api/v2";let o=null,g=null,T=null;chrome.runtime.onInstalled.addListener(()=>{console.log("[ClickUp] Extension installed")});chrome.runtime.onMessage.addListener((t,e,a)=>(f(t,e).then(a),!0));async function f(t,e){const{action:a,data:s}=t;switch(a){case"getStatus":return await w();case"authenticate":return await U();case"logout":return await y();case"saveOAuthConfig":return await E(s);case"getTeams":case"getHierarchy":return await I();case"getSpaces":return await R(t.teamId||s?.teamId);case"getFolders":return await O(t.spaceId||s?.spaceId);case"getLists":return await A({spaceId:t.spaceId||s?.spaceId,folderId:t.folderId||s?.folderId});case"getMembers":return await _(s.listId);case"createTask":return await b(t.emailData||s);case"createTaskFull":return await M(t);case"setDefaultList":return await chrome.storage.local.set({[n.DEFAULT_LIST]:s.listId}),{success:!0};case"getTaskById":return await P(t.taskId||s?.taskId);case"searchTasks":return await N(t.query||s?.query);case"attachToTask":return await F(t);case"validateTask":return await L(t.taskId||s?.taskId);case"findLinkedTasks":return await $(t.threadIds||s);case"testTokenRefresh":return await S();default:return console.log("[ClickUp] Unknown action:",a),{error:"Unknown action"}}}async function w(){const t=await chrome.storage.local.get([n.TOKEN,n.OAUTH_CONFIG,n.USER]);return{authenticated:!!t[n.TOKEN],configured:!!t[n.OAUTH_CONFIG]?.clientId,user:t[n.USER]||null}}async function E(t){return await chrome.storage.local.set({[n.OAUTH_CONFIG]:t}),{success:!0}}async function U(){const e=(await chrome.storage.local.get(n.OAUTH_CONFIG))[n.OAUTH_CONFIG];if(!e?.clientId||!e?.clientSecret)throw new Error("OAuth not configured");const a=chrome.identity.getRedirectURL(),s=`https://app.clickup.com/api?client_id=${e.clientId}&redirect_uri=${encodeURIComponent(a)}`;try{const r=await chrome.identity.launchWebAuthFlow({url:s,interactive:!0});if(!r)throw new Error("No response URL from OAuth flow");const i=new URL(r).searchParams.get("code");if(!i)throw new Error("No authorization code received");const l=await(await fetch("https://api.clickup.com/api/v2/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:e.clientId,client_secret:e.clientSecret,code:i})})).json();if(console.log("[ClickUp] OAuth token response:",JSON.stringify(l,null,2)),l.access_token){await chrome.storage.local.set({[n.TOKEN]:l.access_token,[n.REFRESH_TOKEN]:l.refresh_token||null}),o=new d(l.access_token);const h=await o.getUser();return await chrome.storage.local.set({[n.USER]:h}),{success:!0,user:h}}throw new Error(l.error||"Failed to get token")}catch(r){throw console.error("[ClickUp] OAuth error:",r),r}}async function y(){return await chrome.storage.local.remove([n.TOKEN,n.REFRESH_TOKEN,n.USER,n.TEAMS]),o=null,g=null,T=null,{success:!0}}async function C(){console.log("[ClickUp] Attempting token refresh...");const t=await chrome.storage.local.get([n.OAUTH_CONFIG,n.REFRESH_TOKEN]),e=t[n.OAUTH_CONFIG],a=t[n.REFRESH_TOKEN];if(!a||!e?.clientId)return console.log("[ClickUp] No refresh token available"),!1;try{const r=await(await fetch("https://api.clickup.com/api/v2/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:e.clientId,client_secret:e.clientSecret,refresh_token:a,grant_type:"refresh_token"})})).json();return r.access_token?(await chrome.storage.local.set({[n.TOKEN]:r.access_token,[n.REFRESH_TOKEN]:r.refresh_token||a}),o=new d(r.access_token),console.log("[ClickUp] Token refreshed successfully"),!0):(console.error("[ClickUp] Token refresh failed:",r.error),!1)}catch(s){return console.error("[ClickUp] Token refresh error:",s),!1}}async function S(){console.log("[ClickUp] Starting token/auth test...");try{const e=(await chrome.storage.local.get([n.TOKEN,n.REFRESH_TOKEN]))[n.TOKEN];if(!e)return{success:!1,error:"No token found. Please authenticate first."};console.log("[ClickUp] Note: ClickUp tokens do not expire"),console.log("[ClickUp] Verifying current token...");try{const a=await o.getUser();console.log("[ClickUp] Current token valid. User:",a.user?.username)}catch(a){return{success:!1,error:"Current token is invalid: "+a.message}}console.log("[ClickUp] Testing with corrupted token..."),await chrome.storage.local.set({[n.TOKEN]:"CORRUPTED_TOKEN_TEST"}),o=new d("CORRUPTED_TOKEN_TEST");try{return await o.getUser(),{success:!1,error:"Corrupted token was accepted (unexpected)"}}catch(a){console.log("[ClickUp] Got expected error:",a.message),await chrome.storage.local.set({[n.TOKEN]:e}),o=new d(e);try{return{success:!0,message:`401 handling works! Token restored. User: ${(await o.getUser()).user?.username||"verified"}`}}catch(s){return{success:!1,error:"Failed to restore token: "+s.message}}}}catch(t){return console.error("[ClickUp] Token test error:",t),{success:!1,error:t.message}}}async function I(){return await m(),g||(g=await o.getTeams(),await chrome.storage.local.set({[n.TEAMS]:g})),g}async function R(t){return await m(),await o.getSpaces(t)}async function O(t){return await m(),await o.getFolders(t)}async function A(t){return await m(),t.folderId?await o.getListsInFolder(t.folderId):await o.getListsInSpace(t.spaceId)}async function _(t){return await m(),await o.getListMembers(t)}async function P(t){try{return await m(),await o.getTask(t)}catch(e){return console.log("[ClickUp] Task lookup failed:",t,e.message),null}}async function N(t){await m(),g||(g=await o.getTeams());const e=g.teams[0]?.id;return e?await o.searchTasks(e,t):{tasks:[]}}async function b(t){await m();const a=(await chrome.storage.local.get(n.DEFAULT_LIST))[n.DEFAULT_LIST];if(!a)throw new Error("No default list configured");const s=`https://mail.google.com/mail/u/0/#inbox/${t.threadId}`,r={name:t.subject||"Email Task",description:`\u{1F4E7} **Email from:** ${t.from}

`},c=await o.createTask(a,r);await k(t.threadId,c);try{const i=`\u{1F4E7} **Email vinculado:**
\u{1F517} [Ver email original en Gmail](${s})

_Thread ID: ${t.threadId}_`;await o.addComment(c.id,i)}catch(i){console.error("[ClickUp] Failed to add comment:",i)}if(t.html)try{await o.uploadAttachment(c.id,t.html,t.subject,t)}catch(i){console.error("[ClickUp] Failed to upload attachment:",i)}if(chrome.tabs){const i=await chrome.tabs.query({active:!0,currentWindow:!0});i[0]?.id&&chrome.tabs.sendMessage(i[0].id,{action:"taskCreated",data:{threadId:t.threadId,task:c}})}return c}async function F(t){await m();const{taskId:e,emailData:a}=t,r=`\u{1F4E7} **Email adjuntado:**
\u{1F517} [Ver en Gmail](${`https://mail.google.com/mail/u/0/#inbox/${a.threadId}`})

**From:** ${a.from}
**Subject:** ${a.subject}`;await o.addComment(e,r),a.html&&await o.uploadAttachment(e,a.html,a.subject,a);const c=await o.getTask(e);return await k(a.threadId,c),c}async function M(t){await m();const{listId:e,taskData:a,emailData:s,timeTracked:r,teamId:c}=t;if(!e)throw new Error("No list selected");const i=await o.createTask(e,a);if(s?.threadId){const u=`https://mail.google.com/mail/u/0/#inbox/${s.threadId}`;try{const l=`\u{1F4E7} **Email vinculado:**
\u{1F517} [Ver email original en Gmail](${u})

_Thread ID: ${s.threadId}_`;await o.addComment(i.id,l)}catch(l){console.error("[ClickUp] Failed to add comment:",l)}if(s.html)try{await o.uploadAttachment(i.id,s.html,s.subject||"Email",s)}catch(l){console.error("[ClickUp] Failed to upload attachment:",l)}await k(s.threadId,i)}if(r&&c)try{await o.trackTime(i.id,c,r)}catch(u){console.error("[ClickUp] Failed to track time:",u)}if(chrome.tabs&&s?.threadId){const u=await chrome.tabs.query({active:!0,currentWindow:!0});u[0]?.id&&chrome.tabs.sendMessage(u[0].id,{action:"taskCreated",data:{threadId:s.threadId,task:i}})}return i}async function k(t,e){const s=(await chrome.storage.local.get(n.EMAIL_TASKS))[n.EMAIL_TASKS]||{};s[t]||(s[t]=[]),s[t].find(r=>r.id===e.id)||s[t].push({id:e.id,name:e.name,url:e.url}),await chrome.storage.local.set({[n.EMAIL_TASKS]:s})}async function L(t){try{await m();const e=await o.getTask(t);return e.archived?{exists:!1,reason:"archived"}:{exists:!!(e&&e.id),reason:"exists"}}catch(e){const a=e.status||0,s=(e.message||"").toLowerCase();return a===404||a===403?{exists:!1,reason:"api_error",errorStatus:a}:s.includes("not found")||s.includes("deleted")||s.includes("does not exist")?{exists:!1,reason:"deleted",error:e.message}:{exists:!0,error:e.message}}}async function $(t){const a=(await chrome.storage.local.get(n.EMAIL_TASKS))[n.EMAIL_TASKS]||{},s={};for(const r of t)a[r]&&(s[r]=a[r]);return s}async function m(){if(!o){const t=await chrome.storage.local.get(n.TOKEN);if(t[n.TOKEN])o=new d(t[n.TOKEN]);else throw new Error("Not authenticated")}}class d{constructor(e){this.token=e}static{this.MAX_RETRIES=3}static{this.RETRY_STATUS_CODES=[429,500,502,503,504]}async request(e,a={},s=0){try{const r=await fetch(`${p}${e}`,{...a,headers:{Authorization:this.token,"Content-Type":"application/json",...a.headers}});if(r.status===401&&s===0){if(console.log("[ClickUp] Got 401 Unauthorized, attempting token refresh..."),await C()){const u=await chrome.storage.local.get(n.TOKEN);return this.token=u[n.TOKEN],this.request(e,a,1)}const i=new Error("Authentication failed. Please sign out and sign in again.");throw i.status=401,i.requiresReauth=!0,i}if(d.RETRY_STATUS_CODES.includes(r.status)&&s<d.MAX_RETRIES){const c=Math.pow(2,s)*1e3;return console.log(`[ClickUp] Got ${r.status}, retrying in ${c}ms (attempt ${s+1}/${d.MAX_RETRIES})`),await this.sleep(c),this.request(e,a,s+1)}if(!r.ok){const c=await r.json().catch(()=>({})),i=new Error(c.err||`API Error: ${r.status}`);throw i.status=r.status,i}return r.json()}catch(r){if(r.name==="TypeError"&&r.message.includes("fetch")&&s<d.MAX_RETRIES){const c=Math.pow(2,s)*1e3;return console.log(`[ClickUp] Network error, retrying in ${c}ms (attempt ${s+1}/${d.MAX_RETRIES})`),await this.sleep(c),this.request(e,a,s+1)}throw r}}sleep(e){return new Promise(a=>setTimeout(a,e))}async getUser(){return this.request("/user")}async getTeams(){return this.request("/team")}async getSpaces(e){return this.request(`/team/${e}/space`)}async getFolders(e){return this.request(`/space/${e}/folder`)}async getListsInSpace(e){return this.request(`/space/${e}/list`)}async getListsInFolder(e){return this.request(`/folder/${e}/list`)}async getListMembers(e){return this.request(`/list/${e}/member`)}async createTask(e,a){return this.request(`/list/${e}/task`,{method:"POST",body:JSON.stringify(a)})}async getTask(e){return this.request(`/task/${e}`)}async addComment(e,a){return this.request(`/task/${e}/comment`,{method:"POST",body:JSON.stringify({comment_text:a})})}async searchTasks(e,a){return this.request(`/team/${e}/task?query=${encodeURIComponent(a)}`)}async uploadAttachment(e,a,s,r=null){const c=new FormData,i=(s||"Email").replace(/[<>:"/\\|?*]/g,"").substring(0,100)+".html",u=new Blob([a],{type:"text/html"});if(c.append("attachment",u,i),r?.threadId){const h=JSON.stringify({id:r.threadId,subject:r.subject||s,from:r.from||"",email:r.email||r.userEmail||"",msg:r.threadId,client:"gmail"});c.append("email",h)}const l=await fetch(`${p}/task/${e}/attachment`,{method:"POST",headers:{Authorization:this.token},body:c});if(!l.ok)throw new Error(`Upload failed: ${l.status}`);return l.json()}async trackTime(e,a,s){const r=Date.now();return this.request(`/team/${a}/time_entries`,{method:"POST",body:JSON.stringify({tid:e,start:r-s,duration:s})})}}})();
