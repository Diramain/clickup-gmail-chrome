"use strict";(()=>{document.addEventListener("DOMContentLoaded",E);async function E(){const n=document.getElementById("loading"),a=document.getElementById("login-required"),e=document.getElementById("logged-in");try{const t=await c({action:"getStatus"});n.classList.add("hidden"),t.authenticated?g(t):L(t.configured)}catch(t){console.error("Init error:",t),n.innerHTML=`<p style="color: #ff5252;">Error: ${t.message}</p>`}}function L(n){const a=document.getElementById("login-required"),e=document.getElementById("signIn"),t=document.getElementById("saveConfig"),r=document.getElementById("clientId"),s=document.getElementById("clientSecret"),o=document.getElementById("redirectUrl"),i=document.getElementById("copyUrl"),f=document.getElementById("openWindow");a.classList.remove("hidden");const d=chrome.identity.getRedirectURL();o.value=d,chrome.storage.local.get(["draftClientId","draftClientSecret"],l=>{l.draftClientId&&(r.value=l.draftClientId),l.draftClientSecret&&(s.value=l.draftClientSecret),l.draftClientId&&l.draftClientSecret&&(e.disabled=!1)}),r.addEventListener("input",()=>{chrome.storage.local.set({draftClientId:r.value}),r.value&&s.value&&(e.disabled=!1)}),s.addEventListener("input",()=>{chrome.storage.local.set({draftClientSecret:s.value}),r.value&&s.value&&(e.disabled=!1)}),i.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(d),i.textContent="\u2705",i.style.background="rgba(0, 200, 83, 0.3)",setTimeout(()=>{i.textContent="\u{1F4CB}",i.style.background=""},2e3)}catch{o.select(),document.execCommand("copy"),i.textContent="\u2705"}}),f.addEventListener("click",()=>{chrome.windows.create({url:chrome.runtime.getURL("popup/popup.html"),type:"popup",width:400,height:650,focused:!0}),window.close()}),n&&(e.disabled=!1),t.addEventListener("click",async()=>{const l=r.value.trim(),u=s.value.trim();if(!l||!u){alert("Please enter both Client ID and Client Secret");return}await c({action:"saveOAuthConfig",data:{clientId:l,clientSecret:u}}),e.disabled=!1,t.textContent="Configuration Saved \u2713",t.style.background="rgba(0, 200, 83, 0.2)",t.style.borderColor="#00c853"}),e.addEventListener("click",async()=>{e.disabled=!0,e.textContent="Signing in...";try{const l=await c({action:"authenticate"});l.success&&(a.classList.add("hidden"),g({authenticated:!0,configured:!0,user:l.user}))}catch(l){e.disabled=!1,e.textContent="Sign in with ClickUp",alert("Sign in failed: "+l.message)}})}async function g(n){const a=document.getElementById("logged-in"),e=document.getElementById("userAvatar"),t=document.getElementById("userName"),r=document.getElementById("userEmail");if(a.classList.remove("hidden"),n.user){const s=n.user.user||n.user;t.textContent=s.username||"User",r.textContent=s.email||"",s.profilePicture?e.src=s.profilePicture:e.style.display="none"}await v(),document.getElementById("signOut").addEventListener("click",async()=>{await c({action:"logout"}),location.reload()}),document.getElementById("testTokenRefresh").addEventListener("click",async()=>{const s=document.getElementById("testTokenRefresh"),o=document.getElementById("testResult");s.disabled=!0,s.textContent="\u23F3 Testing...",o.textContent="Corrupting token and testing refresh...",o.style.color="#666";try{const i=await c({action:"testTokenRefresh"});i.success?(o.textContent="\u2705 "+i.message,o.style.color="#00c853"):(o.textContent="\u274C "+(i.error||"Test failed"),o.style.color="#ff5252")}catch(i){o.textContent="\u274C Error: "+i.message,o.style.color="#ff5252"}s.disabled=!1,s.textContent="\u{1F9EA} Test Token Refresh"})}async function v(){const n=document.getElementById("teamSelect"),a=document.getElementById("spaceSelect"),e=document.getElementById("listSelect");try{console.log("[Popup] Loading teams...");const t=await c({action:"getTeams"});if(console.log("[Popup] Teams loaded:",t),!t||!t.teams||t.teams.length===0){console.error("[Popup] No teams found"),n.innerHTML='<option value="">No workspaces found</option>';return}t.teams.forEach(o=>{const i=document.createElement("option");i.value=o.id,i.textContent=o.name,n.appendChild(i)});const r=await chrome.storage.local.get(["defaultList","defaultListConfig"]);console.log("[Popup] Saved config:",r);const s=document.getElementById("clearDefaultList");if(r.defaultListConfig){const o=r.defaultListConfig;o.teamId&&(n.value=o.teamId,await m(o.teamId,o.spaceId,o.listId),s.classList.remove("hidden"))}s.addEventListener("click",async()=>{await chrome.storage.local.remove(["defaultList","defaultListConfig"]),n.value="",a.classList.add("hidden"),a.innerHTML='<option value="">Select Space...</option>',e.classList.add("hidden"),e.innerHTML='<option value="">Select List...</option>',s.classList.add("hidden"),C()}),n.addEventListener("change",async()=>{const o=n.value;o&&await m(o)}),a.addEventListener("change",async()=>{const o=a.value;o&&await p(o)}),e.addEventListener("change",async()=>{const o=e.value,i=e.options[e.selectedIndex]?.text||"";o&&(await chrome.storage.local.set({defaultList:o,defaultListConfig:{teamId:n.value,spaceId:a.value,listId:o,listName:i}}),await c({action:"setDefaultList",data:{listId:o}}),e.style.borderColor="#00c853",y(),setTimeout(()=>{e.style.borderColor=""},2e3))})}catch(t){console.error("[Popup] Load teams error:",t),n.innerHTML='<option value="">Error loading workspaces</option>'}}async function m(n,a,e){const t=document.getElementById("spaceSelect"),r=document.getElementById("listSelect");t.innerHTML='<option value="">Loading...</option>',t.classList.remove("hidden"),r.classList.add("hidden");try{const s=await c({action:"getSpaces",data:{teamId:n}});t.innerHTML='<option value="">Select Space...</option>',s.spaces.forEach(o=>{const i=document.createElement("option");i.value=o.id,i.textContent=o.name,t.appendChild(i)}),a&&(t.value=a,await p(a,e))}catch(s){console.error("[Popup] Load spaces error:",s),t.innerHTML='<option value="">Error loading spaces</option>'}}async function p(n,a){const e=document.getElementById("listSelect");e.innerHTML='<option value="">Loading...</option>',e.classList.remove("hidden");try{const t=await c({action:"getLists",data:{spaceId:n}});e.innerHTML='<option value="">Select List...</option>',t.lists.forEach(r=>{const s=document.createElement("option");s.value=r.id,s.textContent=r.name,e.appendChild(s)}),a&&(e.value=a,e.style.borderColor="#00c853")}catch(t){console.error("[Popup] Load lists error:",t),e.innerHTML='<option value="">Error loading lists</option>'}}function y(){const n=document.createElement("div");n.className="saved-indicator",n.textContent="\u2713 Saved",n.style.cssText="color:#00c853;font-size:12px;margin-top:5px;text-align:center;";const a=document.querySelector(".saved-indicator");a&&a.remove(),document.getElementById("listSelect")?.parentElement?.appendChild(n),setTimeout(()=>n.remove(),3e3),document.getElementById("clearDefaultList")?.classList.remove("hidden")}function C(){const n=document.createElement("div");n.className="saved-indicator",n.textContent="\u{1F5D1}\uFE0F Cleared",n.style.cssText="color:#ff9800;font-size:12px;margin-top:5px;text-align:center;";const a=document.querySelector(".saved-indicator");a&&a.remove(),document.getElementById("teamSelect")?.parentElement?.appendChild(n),setTimeout(()=>n.remove(),3e3)}function c(n){return new Promise((a,e)=>{chrome.runtime.sendMessage(n,t=>{chrome.runtime.lastError?e(new Error(chrome.runtime.lastError.message)):t?.error?e(new Error(t.error)):a(t)})})}})();
