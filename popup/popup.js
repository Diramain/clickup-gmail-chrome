"use strict";(()=>{document.addEventListener("DOMContentLoaded",L);async function L(){const n=document.getElementById("loading"),a=document.getElementById("login-required"),o=document.getElementById("logged-in");try{const s=await r({action:"getStatus"});n.classList.add("hidden"),s.authenticated?f(s):C(s.configured)}catch(s){console.error("Init error:",s),n.innerHTML=`<p style="color: #ff5252;">Error: ${s.message}</p>`}}function C(n){const a=document.getElementById("login-required"),o=document.getElementById("signIn"),s=document.getElementById("saveConfig"),c=document.getElementById("clientId"),t=document.getElementById("clientSecret"),e=document.getElementById("redirectUrl"),i=document.getElementById("copyUrl"),m=document.getElementById("openWindow");a.classList.remove("hidden");const d=chrome.identity.getRedirectURL();e.value=d,chrome.storage.local.get(["draftClientId","draftClientSecret"],l=>{l.draftClientId&&(c.value=l.draftClientId),l.draftClientSecret&&(t.value=l.draftClientSecret),l.draftClientId&&l.draftClientSecret&&(o.disabled=!1)}),c.addEventListener("input",()=>{chrome.storage.local.set({draftClientId:c.value}),c.value&&t.value&&(o.disabled=!1)}),t.addEventListener("input",()=>{chrome.storage.local.set({draftClientSecret:t.value}),c.value&&t.value&&(o.disabled=!1)}),i.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(d),i.textContent="\u2705",i.style.background="rgba(0, 200, 83, 0.3)",setTimeout(()=>{i.textContent="\u{1F4CB}",i.style.background=""},2e3)}catch{e.select(),document.execCommand("copy"),i.textContent="\u2705"}}),m.addEventListener("click",()=>{chrome.windows.create({url:chrome.runtime.getURL("popup/popup.html"),type:"popup",width:400,height:650,focused:!0}),window.close()}),n&&(o.disabled=!1),s.addEventListener("click",async()=>{const l=c.value.trim(),u=t.value.trim();if(!l||!u){alert("Please enter both Client ID and Client Secret");return}await r({action:"saveOAuthConfig",data:{clientId:l,clientSecret:u}}),o.disabled=!1,s.textContent="Configuration Saved \u2713",s.style.background="rgba(0, 200, 83, 0.2)",s.style.borderColor="#00c853"}),o.addEventListener("click",async()=>{o.disabled=!0,o.textContent="Signing in...";try{const l=await r({action:"authenticate"});l.success&&(a.classList.add("hidden"),f({authenticated:!0,configured:!0,user:l.user}))}catch(l){o.disabled=!1,o.textContent="Sign in with ClickUp",alert("Sign in failed: "+l.message)}})}async function f(n){const a=document.getElementById("logged-in"),o=document.getElementById("userAvatar"),s=document.getElementById("userName"),c=document.getElementById("userEmail");if(a.classList.remove("hidden"),n.user){const t=n.user.user||n.user;s.textContent=t.username||"User",c.textContent=t.email||"",t.profilePicture?o.src=t.profilePicture:o.style.display="none"}await v(),await T(),document.getElementById("signOut").addEventListener("click",async()=>{await r({action:"logout"}),location.reload()}),document.getElementById("testTokenRefresh").addEventListener("click",async()=>{const t=document.getElementById("testTokenRefresh"),e=document.getElementById("testResult");t.disabled=!0,t.textContent="\u23F3 Testing...",e.textContent="Corrupting token and testing refresh...",e.style.color="#666";try{const i=await r({action:"testTokenRefresh"});i.success?(e.textContent="\u2705 "+i.message,e.style.color="#00c853"):(e.textContent="\u274C "+(i.error||"Test failed"),e.style.color="#ff5252")}catch(i){e.textContent="\u274C Error: "+i.message,e.style.color="#ff5252"}t.disabled=!1,t.textContent="\u{1F9EA} Test Token Refresh"}),document.getElementById("syncLists")?.addEventListener("click",async()=>{const t=document.getElementById("syncLists"),e=document.getElementById("syncStatus"),i=t.querySelector(".btn-text"),m=t.querySelector(".spinner");t.disabled=!0,i.textContent="Syncing...",m?.classList.remove("hidden"),e.textContent="Loading all spaces and lists...",e.style.color="#666";try{const d=Date.now(),l=await r({action:"preloadFullHierarchy"}),u=((Date.now()-d)/1e3).toFixed(1);l.success?(e.textContent=`\u2705 Synced ${l.listCount} lists in ${u}s`,e.style.color="#00c853"):(e.textContent="\u274C Sync failed",e.style.color="#ff5252")}catch(d){e.textContent="\u274C Error: "+d.message,e.style.color="#ff5252"}t.disabled=!1,i.textContent="\u{1F504} Sync Lists",m?.classList.add("hidden")}),await I(),document.getElementById("syncEmailTasks")?.addEventListener("click",async()=>{const t=document.getElementById("syncEmailTasks"),e=document.getElementById("emailSyncStatus"),i=document.getElementById("emailSyncDays"),m=t.querySelector(".btn-text"),d=t.querySelector(".spinner"),l=parseInt(i.value);t.disabled=!0,m.textContent="Syncing...",d?.classList.remove("hidden"),e.textContent=`Scanning tasks from last ${l} days...`,e.style.color="#666";try{const u=Date.now(),g=await r({action:"syncEmailTasks",data:{days:l}}),E=((Date.now()-u)/1e3).toFixed(1);g.success?(e.textContent=`\u2705 Found ${g.foundCount} linked tasks in ${E}s`,e.style.color="#00c853"):(e.textContent="\u274C Sync failed",e.style.color="#ff5252")}catch(u){e.textContent="\u274C Error: "+u.message,e.style.color="#ff5252"}t.disabled=!1,m.textContent="\u{1F504} Sync",d?.classList.add("hidden")})}async function v(){const n=document.getElementById("teamSelect"),a=document.getElementById("spaceSelect"),o=document.getElementById("listSelect");try{console.log("[Popup] Loading teams...");const s=await r({action:"getTeams"});if(console.log("[Popup] Teams loaded:",s),!s||!s.teams||s.teams.length===0){console.error("[Popup] No teams found"),n.innerHTML='<option value="">No workspaces found</option>';return}s.teams.forEach(e=>{const i=document.createElement("option");i.value=e.id,i.textContent=e.name,n.appendChild(i)});const c=await chrome.storage.local.get(["defaultList","defaultListConfig"]);console.log("[Popup] Saved config:",c);const t=document.getElementById("clearDefaultList");if(c.defaultListConfig){const e=c.defaultListConfig;e.teamId&&(n.value=e.teamId,await y(e.teamId,e.spaceId,e.listId),t.classList.remove("hidden"))}t.addEventListener("click",async()=>{await chrome.storage.local.remove(["defaultList","defaultListConfig"]),n.value="",a.classList.add("hidden"),a.innerHTML='<option value="">Select Space...</option>',o.classList.add("hidden"),o.innerHTML='<option value="">Select List...</option>',t.classList.add("hidden"),S()}),n.addEventListener("change",async()=>{const e=n.value;e&&await y(e)}),a.addEventListener("change",async()=>{const e=a.value;e&&await p(e)}),o.addEventListener("change",async()=>{const e=o.value,i=o.options[o.selectedIndex]?.text||"";e&&(await chrome.storage.local.set({defaultList:e,defaultListConfig:{teamId:n.value,spaceId:a.value,listId:e,listName:i}}),await r({action:"setDefaultList",data:{listId:e}}),o.style.borderColor="#00c853",h(),setTimeout(()=>{o.style.borderColor=""},2e3))})}catch(s){console.error("[Popup] Load teams error:",s),n.innerHTML='<option value="">Error loading workspaces</option>'}}async function y(n,a,o){const s=document.getElementById("spaceSelect"),c=document.getElementById("listSelect");s.innerHTML='<option value="">Loading...</option>',s.classList.remove("hidden"),c.classList.add("hidden");try{const t=await r({action:"getSpaces",data:{teamId:n}});s.innerHTML='<option value="">Select Space...</option>',t.spaces.forEach(e=>{const i=document.createElement("option");i.value=e.id,i.textContent=e.name,s.appendChild(i)}),a&&(s.value=a,await p(a,o))}catch(t){console.error("[Popup] Load spaces error:",t),s.innerHTML='<option value="">Error loading spaces</option>'}}async function p(n,a){const o=document.getElementById("listSelect");o.innerHTML='<option value="">Loading...</option>',o.classList.remove("hidden");try{const s=await r({action:"getLists",data:{spaceId:n}});o.innerHTML='<option value="">Select List...</option>',s.lists.forEach(c=>{const t=document.createElement("option");t.value=c.id,t.textContent=c.name,o.appendChild(t)}),a&&(o.value=a,o.style.borderColor="#00c853")}catch(s){console.error("[Popup] Load lists error:",s),o.innerHTML='<option value="">Error loading lists</option>'}}function h(){const n=document.createElement("div");n.className="saved-indicator",n.textContent="\u2713 Saved",n.style.cssText="color:#00c853;font-size:12px;margin-top:5px;text-align:center;";const a=document.querySelector(".saved-indicator");a&&a.remove(),document.getElementById("listSelect")?.parentElement?.appendChild(n),setTimeout(()=>n.remove(),3e3),document.getElementById("clearDefaultList")?.classList.remove("hidden")}function S(){const n=document.createElement("div");n.className="saved-indicator",n.textContent="\u{1F5D1}\uFE0F Cleared",n.style.cssText="color:#ff9800;font-size:12px;margin-top:5px;text-align:center;";const a=document.querySelector(".saved-indicator");a&&a.remove(),document.getElementById("teamSelect")?.parentElement?.appendChild(n),setTimeout(()=>n.remove(),3e3)}async function T(){const n=document.getElementById("syncStatus");try{const a=await r({action:"getHierarchyCache"});if(a&&a.timestamp){const o=Date.now()-a.timestamp,s=Math.floor(o/6e4),c=Math.floor(s/60);let t="";if(c>24){const i=Math.floor(c/24);t=`${i} day${i>1?"s":""} ago`}else c>0?t=`${c} hour${c>1?"s":""} ago`:s>0?t=`${s} min${s>1?"s":""} ago`:t="just now";const e=a.lists?.length||0;n.textContent=`\u2705 ${e} lists synced ${t}`,n.style.color="#00c853"}else n.textContent="\u26A0\uFE0F Not synced yet - click to sync",n.style.color="#ff9800"}catch{n.textContent="Pre-load lists for faster task creation"}}async function I(){const n=document.getElementById("emailSyncStatus");try{const a=await r({action:"getEmailTasksSyncStatus"});if(a&&a.lastSync){const o=Date.now()-a.lastSync,s=Math.floor(o/6e4),c=Math.floor(s/60);let t="";if(c>24){const e=Math.floor(c/24);t=`${e} day${e>1?"s":""} ago`}else c>0?t=`${c} hour${c>1?"s":""} ago`:s>0?t=`${s} min${s>1?"s":""} ago`:t="just now";n.textContent=`\u2705 ${a.foundCount||0} links found ${t}`,n.style.color="#00c853"}else n.textContent="\u26A0\uFE0F Not synced - for migrating to new PC",n.style.color="#ff9800"}catch{n.textContent="Sync tasks linked to emails"}}function r(n){return new Promise((a,o)=>{chrome.runtime.sendMessage(n,s=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):s?.error?o(new Error(s.error)):a(s)})})}})();
